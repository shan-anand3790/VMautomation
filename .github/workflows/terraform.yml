name: Mock Cost Test

on:
  push:
    paths:
      - 'vm_inputs.json'
  workflow_dispatch:

jobs:
  # JOB 1: FAKE COST CALCULATION (No Terraform needed)
  estimate_cost:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Calculate Mock Price
        id: cost
        run: |
          echo "Simulating Infracost calculation..."
          # We pick a random price to prove it's working
          PRICE="75.50"
          echo "calculated_price=$PRICE" >> $GITHUB_OUTPUT

      - name: Send Price to Chatbot
        env:
          WEBHOOK_URL: ${{ secrets.CHATBOT_WEBHOOK_URL }}
          PRICE: ${{ steps.cost.outputs.calculated_price }}
        run: |
          echo "Sending Price: $PRICE to $WEBHOOK_URL"
          
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"type\": \"cost_estimate\", \"cost\": \"$PRICE\"}" \
            "$WEBHOOK_URL"

  # JOB 2: REAL DEPLOYMENT (Only runs after you click Approve)
  deploy_vm:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to Azure
        run: |
          echo "This step would run 'terraform apply' in real life."
          echo "Deployment Successful!"

      - name: Send Success to Chatbot
        env:
          WEBHOOK_URL: ${{ secrets.CHATBOT_WEBHOOK_URL }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{"type": "deployment_success", "ip": "10.0.0.99"}' \
            "$WEBHOOK_URL"
